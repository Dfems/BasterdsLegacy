# /etc/apache2/sites-available/basterdslegacy.conf

# Redirect HTTP -> HTTPS
<VirtualHost *:80>
    ServerName basterdslegacy.ddns.net
    RewriteEngine On
    RewriteRule ^/(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName basterdslegacy.ddns.net

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/basterdslegacy.ddns.net/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/basterdslegacy.ddns.net/privkey.pem

    # Static frontend built by Vite
    # Nota: correggi la cartella se era stata creata come /var/www/basterdlegacy
    DocumentRoot /var/www/basterdslegacy
    <Directory /var/www/basterdslegacy>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
        FallbackResource /index.html
    </Directory>

    # Reverse proxy to Fastify backend on port 3000
    ProxyPreserveHost On
    ProxyRequests Off

    # API routes
    ProxyPass /api http://127.0.0.1:3000/api retry=0
    ProxyPassReverse /api http://127.0.0.1:3000/api

    # WebSockets
    ProxyPass /ws ws://127.0.0.1:3000/ws retry=0
    ProxyPassReverse /ws ws://127.0.0.1:3000/ws

    ErrorLog ${APACHE_LOG_DIR}/basterdslegacy_error.log
    CustomLog ${APACHE_LOG_DIR}/basterdslegacy_access.log combined
</VirtualHost>
</IfModule>

# Enable required modules (once):
#   sudo a2enmod ssl rewrite proxy proxy_http proxy_wstunnel headers
#   sudo a2ensite basterdslegacy && sudo systemctl reload apache2
